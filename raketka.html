{% extends "main.html" %}

{% block raketka %}
    <div class="container">
        <h1><a href=" {{ '/' }}">Главная</a></h1>
        <h1 class="text-center mt-4">Игра "Ракетка"</h1>
        <h2 class="text-center" id="current-coef">Коэффициент: 1.00</h2>
        <div id="rocket-image-container" class="d-flex justify-content-center">
            <img id="rocket-img" src="{{ url_for('static', filename='images/rocket.jpeg') }}" alt="Ракета" style="max-width: 80%; height: auto;">
        </div>

        <canvas id="flightChart" width="400" height="200" class="mt-4"></canvas>
        <form id="raketka-form" class="mt-4">
            <div class="mb-3">
                <label for="bet" class="form-label">Введите вашу ставку (мин. 10 токенов):</label>
                <input type="number" class="form-control" id="bet" name="bet" min="10" required>
            </div>
            <div class="mb-3">
                <label for="auto_stop" class="form-label">Введите автостоп (мин. 1.25):</label>
                <input type="number" step="0.01" class="form-control" id="auto_stop" name="auto_stop" min="1.25" required>
            </div>
            <button type="submit" class="btn btn-primary">Запустить ракету</button>
        </form>

        <button id="stop-rocket" class="btn btn-danger mt-3" style="display:none;">Остановить ракету и забрать выигрыш</button>

        <h3 class="text-center mt-4">Текущий коэффициент: <span id="real-time-coef">1.00</span></h3>

        <div id="result" class="mt-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let coefElement = document.getElementById('current-coef');
        let realTimeCoef = document.getElementById('real-time-coef');
        let stopButton = document.getElementById('stop-rocket');
        let ctx = document.getElementById('flightChart').getContext('2d');
        let flightData = {
            labels: [],
            datasets: [{
                label: 'Траектория полета ракеты',
                borderColor: 'rgb(75, 192, 192)',
                data: [],
                fill: false,
                tension: 0.3  // Добавим кривизну
            }]
        };

        let chart = new Chart(ctx, {
            type: 'line',
            data: flightData,
            options: {
                scales: {
                    x: {
                        title: { display: true, text: 'Время' }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Коэффициент' }
                    }
                }
            }
        });

        function resetFlightChart() {
            flightData.labels = [];
            flightData.datasets[0].data = [];
            chart.update();
        }

        let rocketInterval;
        let currentCoef = 1.00;

        function animateRocketFlight(crashCoef, autoStop, callback) {
            let t = 0;  
            rocketInterval = setInterval(() => {
                t += 1;
                currentCoef = 1 + Math.pow(t / 100, 2); 

                coefElement.innerHTML = `Коэффициент: ${currentCoef.toFixed(2)}`;
                realTimeCoef.innerHTML = currentCoef.toFixed(2);


                flightData.labels.push(t);  
                flightData.datasets[0].data.push(currentCoef);  
                chart.update();


                if (currentCoef >= autoStop || currentCoef >= crashCoef) {
                    clearInterval(rocketInterval);
                    stopButton.style.display = 'none'; 
                    callback(currentCoef);
                }
            }, 150); 
        }

        document.getElementById('raketka-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const bet = document.getElementById('bet').value;
            const auto_stop = parseFloat(document.getElementById('auto_stop').value);

            resetFlightChart();


            document.getElementById('result').innerHTML = '';


            stopButton.style.display = 'block';


            fetch('/raketka/play', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ bet: bet, auto_stop: auto_stop })
            })
            .then(response => response.json())
            .then(data => {
                const crashCoef = data.coef;


                animateRocketFlight(crashCoef, auto_stop, (finalCoef) => {
                    document.getElementById('result').innerHTML = `
                        <p>${data.message}</p>
                        <p>Баланс: ${data.balance}</p>
                    `;
                });
            });
        });


        stopButton.addEventListener('click', function() {
            clearInterval(rocketInterval);  
            stopButton.style.display = 'none';  
            document.getElementById('result').innerHTML = `
                <p>Вы остановили ракету на коэффициенте ${currentCoef.toFixed(2)}</p>
                <p>Ваш выигрыш: ${(currentCoef * document.getElementById('bet').value).toFixed(2)} токенов</p>
            `;
        });
    </script>
{% endblock %}